{% extends "base.html" %}
{% block content %}
  <div class="d-flex flex-wrap justify-content-between gap-2 align-items-end mb-3">
    <div>
      <h3 class="page-title">Dashboard</h3>
      <div class="page-subtitle">Quick view of your home: alerts, sensors, and cameras.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Refresh</a>
      <a class="btn btn-outline-primary" href="{{ url_for('events') }}">View Activity</a>
      <a class="btn btn-primary" href="{{ url_for('training') }}">Training</a>
    </div>
  </div>

  <div class="row g-3 mb-3 fade-in">
    <div class="col-12 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Current Alerts</div>
        <div class="kpi-value">{{ active_alert_count }}</div>
        <div class="kpi-sub">Mark each alert as fixed when done.</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Sensors Working</div>
        <div class="kpi-value">{{ sensors_online }}/{{ sensors_total }}</div>
        <div class="kpi-sub">Smoke + door sensors.</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Cameras Working</div>
        <div class="kpi-value">{{ cameras_online }}/{{ cameras_total }}</div>
        <div class="kpi-sub">Indoor and outdoor cameras.</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Guest Mode</div>
        <div class="kpi-value">{{ "ON" if guest_mode else "OFF" }}</div>
        <div class="kpi-sub">Pauses intruder alerts while guests are around.</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3 fade-in">
    {% for card in room_cards %}
      <div class="col-12 col-lg-6">
        <div class="card hover-lift h-100">
          <div class="card-body">
            <div class="room-card-header">
              <div class="room-title">{{ card.room }}</div>
              <span class="evidence-pill">Room status</span>
            </div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="small text-secondary text-uppercase">Sensors</div>
                {% if card.sensors|length == 0 %}
                  <div class="text-secondary small">No sensors assigned.</div>
                {% else %}
                  {% for s in card.sensors %}
                    <div class="status-row">
                      <div>
                        <span class="status-dot {{ 'status-online' if s.online else 'status-offline' }}"></span>
                        {{ s.label }}
                      </div>
                      <div class="mono small">{{ s.last_seen_ts or "-" }}</div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              <div class="col-12 col-md-6">
                <div class="small text-secondary text-uppercase">Cameras</div>
                {% if card.cameras|length == 0 %}
                  <div class="text-secondary small">No cameras assigned.</div>
                {% else %}
                  {% for c in card.cameras %}
                    <div class="status-row">
                      <div>
                        <span class="status-dot {{ 'status-online' if c.online else 'status-offline' }}"></span>
                        {{ c.label }}
                      </div>
                      <div class="mono small">{{ c.last_seen_ts or "-" }}</div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-secondary text-uppercase mb-2">Latest Signals</div>
              <div class="status-row">
                <div>Smoke Alert</div>
                <div class="mono small">{{ card.latest_smoke.ts if card.latest_smoke else "-" }}</div>
              </div>
              <div class="status-row">
                <div>Flame Alert</div>
                <div class="mono small">{{ card.latest_flame.ts if card.latest_flame else "-" }}</div>
              </div>
              <div class="status-row">
                <div>Door Force</div>
                <div class="mono small">{{ card.latest_door_force.ts if card.latest_door_force else "-" }}</div>
              </div>
              <div class="status-row">
                <div>Unknown Person</div>
                <div class="mono small">{{ card.latest_unknown.ts if card.latest_unknown else "-" }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="card shadow-sm mb-3 fade-in">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Live Camera View</h5>
        <span class="text-secondary small">Feeds will appear once cameras are connected.</span>
      </div>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="small text-secondary text-uppercase mb-2">Outdoor View</div>
          {% if outdoor_url %}
            <img id="outdoorFeed" class="camera-feed" src="{{ outdoor_url }}?t=0" data-base-src="{{ outdoor_url }}" alt="Outdoor camera feed">
          {% else %}
            <div class="camera-placeholder">Outdoor camera not connected yet.</div>
          {% endif %}
        </div>
        <div class="col-12 col-lg-6">
          <div class="small text-secondary text-uppercase mb-2">Indoor View</div>
          {% if indoor_url %}
            <img id="indoorFeed" class="camera-feed" src="{{ indoor_url }}?t=0" data-base-src="{{ indoor_url }}" alt="Indoor camera feed">
          {% else %}
            <div class="camera-placeholder">Indoor camera not connected yet.</div>
          {% endif %}
        </div>
      </div>
      <div class="text-secondary small mt-2">Mobile-safe preview mode is enabled.</div>
    </div>
  </div>

  <div class="card shadow-sm mb-3 fade-in">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Current Alerts</h5>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('history') }}">View Past Alerts</a>
      </div>
      {% if alerts|length == 0 %}
        <div class="text-secondary">No current alerts.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Alert</th>
                <th>Area</th>
                <th>Level</th>
                <th>Time</th>
                <th>Notes</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for a in alerts %}
              <tr>
                <td class="mono">#{{ a["id"] }}</td>
                <td><span class="badge text-bg-secondary">{{ a["type"] }}</span></td>
                <td>{{ a["room"] or "-" }}</td>
                <td>
                  {% if a["severity"]|int >= 3 %}
                    <span class="alert-badge alert-high">High</span>
                  {% elif a["severity"]|int == 2 %}
                    <span class="alert-badge alert-med">Med</span>
                  {% else %}
                    <span class="alert-badge alert-low">Low</span>
                  {% endif %}
                </td>
                <td class="mono small">{{ a["ts"] }}</td>
                <td class="text-break">{{ a["details"] or "" }}</td>
                <td>
                  <div class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('alert_details', alert_id=a['id']) }}">Details</a>
                    <form method="post" action="{{ url_for('ack', alert_id=a['id']) }}" class="d-flex gap-2">
                      <select name="status" class="form-select form-select-sm">
                        <option value="ACK">Acknowledge</option>
                        <option value="RESOLVED">Resolved</option>
                      </select>
                      <button class="btn btn-sm btn-outline-primary" type="submit">Submit</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm fade-in">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Recent Activity</h5>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('events') }}">View All Activity</a>
      </div>
      {% if recent_events|length == 0 %}
        <div class="text-secondary">No activity yet.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr><th>What</th><th>Device</th><th>Area</th><th>Time</th></tr>
            </thead>
            <tbody>
              {% for e in recent_events %}
                <tr>
                  <td>{{ e["type"] }}</td>
                  <td>{{ e["source"] }}</td>
                  <td>{{ e["room"] or "-" }}</td>
                  <td class="mono small">{{ e["ts"] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block page_scripts %}
<script>
  (function () {
    const refreshMs = {{ camera_refresh_ms|int }};
    const feeds = [
      document.getElementById("outdoorFeed"),
      document.getElementById("indoorFeed")
    ].filter(Boolean);

    feeds.forEach((img) => {
      const base = img.dataset.baseSrc;
      if (!base) return;
      setInterval(() => {
        if (document.hidden) return;
        img.src = `${base}?t=${Date.now()}`;
      }, refreshMs);
    });
  })();
</script>
{% endblock %}
